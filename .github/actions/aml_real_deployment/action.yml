name: aml_real_deployment

description: execute an online endpoint for real time inference

inputs:
  SUBSCRIPTION_ID:
    description: "subscription id needed for deployment"
    required: true
  use_case_base_path:
    description: "the flow to be registered and deployed"
    required: true
  MODEL_VERSION:
    description: "flow version in registry to be deployed"
    required: true
  DEPLOY_ENVIRONMENT:
    description: "env stage e.g. dev, test, prod"
    required: true
  RESOURCE_GROUP_NAME:
    description: "Resource group name"
    required: true
  WORKSPACE_NAME:
    description: "Workspace name"
    required: true
  KEY_VAULT_NAME:
    description: "Key vault name"
    required: true
  ENV_VARS:
    description: 'The API key for authentication'
    required: false

runs:
  using: composite
  steps:
    - name: Create .env file
      shell: bash
      run: |
        echo "${{ inputs.ENV_VARS }}" >> .env
        for var in $(cat .env); do
          echo "$var" >> $GITHUB_ENV
        done
    - name: load .env file
      shell: bash
      run: python -c "from dotenv import load_dotenv; load_dotenv()"
      
    - name: Provision Managed Endpoint
      uses: ./.github/actions/execute_script
      with:
        step_name: "Provision Managed Endpoint"
        script_parameter: |
          python -m llmops.common.deployment.provision_endpoint \
            --subscription_id ${{ inputs.SUBSCRIPTION_ID }} \
            --build_id ${{ github.run_id }} \
            --output_file "endpoint_principal.txt" \
            --env_name ${{ inputs.DEPLOY_ENVIRONMENT }} \
            --base_path ${{ inputs.use_case_base_path }}

    - name: Read system managed id information
      shell: bash
      run: |
        readarray arr <"endpoint_principal.txt"
        endpoint_principal=${arr[0]}
        echo $endpoint_principal
        echo "ENDPOINT_PRINCIPAL=${endpoint_principal}"  >> "$GITHUB_ENV"
        
    - name: Provision Managed Deployment
      uses: ./.github/actions/execute_script
      with:
        step_name: "Provision Managed Deployment"
        script_parameter: |
          python -m llmops.common.deployment.provision_deployment \
            --subscription_id ${{ inputs.SUBSCRIPTION_ID }} \
            --model_version ${{ inputs.MODEL_VERSION }} \
            --build_id ${{ github.run_id }} \
            --env_name ${{ inputs.DEPLOY_ENVIRONMENT }} \
            --base_path ${{ inputs.use_case_base_path }}

    - name: Test Managed Deployment
      uses: ./.github/actions/execute_script
      with:
        step_name: "Test Managed Deployment"
        script_parameter: |
          python -m llmops.common.deployment.test_model_on_aml \
            --subscription_id ${{ inputs.SUBSCRIPTION_ID }} \
            --env_name ${{ inputs.DEPLOY_ENVIRONMENT }} \
            --base_path ${{ inputs.use_case_base_path }}